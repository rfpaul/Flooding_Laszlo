/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var champaign = ee.FeatureCollection("users/RobertFPaul/ChampaignCounty");
/***** End of imports. If edited, may not auto-convert in the playground. *****/


// Load Sentinel-1 images to map Champaign County flooding.
// This script was originally written by Simon Ilyushchenko (GEE team)
// and adapted by Simon Gascoin (CNRS/CESBIO) and Michel Le Page (IRD/CESBIO)

// Good dates for wet observations: 2016-09-14



// Create a mask of all pixels matching CDL crop class indices
// for the specified years within the extent
var CDL_Mask = function(years, crops, extent) {
  var year;
  var crop;
  var temp_img;
  var year_img;
  var crop_img;
  // Result-holding raster filled with 0 values
  var result_img = ee.Image(0).clip(extent);
  
  // Go through each year to extract
  for (year in years) {
    // Crop-holding raster filled with 0 values
    crop_img = ee.Image(0).clip(extent);
    // Get CDL for current year and clip it
    year_img = ee.Image('USDA/NASS/CDL/' + years[year]);
    print(year_img);
    year_img = year_img.select('cropland').clip(extent);
    
    // Combine crops together
    for (crop in crops) {
      // Crop matches index
      temp_img = year_img.eq(crops[crop]);
      // Union with crop image
      crop_img = crop_img.or(temp_img);
    }
    // Union combined crop mask with previous mask results
    result_img = result_img.or(crop_img);
  }
  // Return resulting mask
  return result_img;
}

// Max values of cloudless pixels in the growing season
var cloud_masked = lsat.map(CloudMask).max();

// Load Cropland Data Layer of maize and soybeans plots from 2013-2016
// Change champaign to clip region
var cdl_cult = CDL_Mask([2013, 2014, 2015, 2016], [1, 5], champaign);
print(cdl_cult);

// Define visualization parameters for a false color image.
// NIR is green, SWIR1 is red, SWIR2 is blue
var vizParams = {'bands': ['B6', 'B5', 'B7'], 'max': .8, 'gamma': 1.6};

// Mask image
var masked_lsat = cloud_masked.updateMask(cdl_cult);

// Default location
var pt = champaign;

// Load Sentinel-1 C-band SAR Ground Range collection (log scaling, VV co-polar)
var collection =  ee.ImageCollection('COPERNICUS/S1_GRD').filterBounds(pt)
.filter(ee.Filter.listContains('transmitterReceiverPolarisation', 'VV'))
.select('VV');



// Filter by date
var dry = collection.filterDate('2016-09-15', '2016-09-30').mosaic();
var wet = collection.filterDate('2016-09-09', '2016-09-14').mosaic();

wet = wet.focal_median(SMOOTHING_RADIUS, 'circle', 'meters').clip(champaign);

// Threshold smoothed radar intensities to identify "flooded" areas.
var SMOOTHING_RADIUS = 100;
var DIFF_UPPER_THRESHOLD = -7; 

var diff_smoothed = wet.focal_median(SMOOTHING_RADIUS, 'circle', 'meters')
    .subtract(dry.focal_median(SMOOTHING_RADIUS, 'circle', 'meters'));

var diff_thresholded = diff_smoothed.lt(DIFF_UPPER_THRESHOLD);

// Display map
Map.centerObject(pt, 11);
Map.addLayer(dry, {min:-25,max:0}, 'Dry');
Map.addLayer(wet, {min:-25,max:0}, 'Wet');
//Map.addLayer(wet.subtract(dry), {min:-10,max:10}, 'wet - dry', 0); 
//Map.addLayer(diff_smoothed, {min:-10,max:10}, 'diff smoothed', 0); 
//Map.addLayer(diff_thresholded.updateMask(diff_thresholded),
//  {palette:"0000FF"},'flooded areas - blue',1);