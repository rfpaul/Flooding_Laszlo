/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var champaign = ee.FeatureCollection("users/RobertFPaul/ChampaignCounty"),
    sinks = ee.Image("users/RobertFPaul/Champ_sinks_x10cm"),
    trainers = ee.FeatureCollection("users/RobertFPaul/unified_training_polys"),
    plImage = ee.Image("users/RobertFPaul/PL/2017-05-05_Combined"),
    waterCai = /* color: #bf04c2 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.14451217651367, 40.30725083828771],
                  [-88.13914775848389, 40.307054478036626],
                  [-88.13884735107422, 40.307479924525815]]]),
            {
              "Type": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.13601493835449, 40.28931424721996],
                  [-88.13601493835449, 40.28872500834958],
                  [-88.1352424621582, 40.28833217958204],
                  [-88.1354570388794, 40.28918330569272]]]),
            {
              "Type": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.13446998596191, 40.28757925139588],
                  [-88.1346845626831, 40.28715367958055],
                  [-88.13442707061768, 40.286891787900835],
                  [-88.1337833404541, 40.28751377898331]]]),
            {
              "Type": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.1303071975708, 40.2826686444629],
                  [-88.13039302825928, 40.28217756414925],
                  [-88.12992095947266, 40.28230851924835]]]),
            {
              "Type": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.1239128112793, 40.278085089474956],
                  [-88.12283992767334, 40.27765945788743],
                  [-88.12228202819824, 40.27828153391935]]]),
            {
              "Type": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.13504934310913, 40.27735660301099],
                  [-88.13486695289612, 40.27714378525925],
                  [-88.13482403755188, 40.27733204715076]]]),
            {
              "Type": 1,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.13213109970093, 40.28076159594019],
                  [-88.13172340393066, 40.28079433542445],
                  [-88.1313157081604, 40.28063063784455],
                  [-88.13116550445557, 40.2807452261921],
                  [-88.13189506530762, 40.28089255378213]]]),
            {
              "Type": 1,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.13185214996338, 40.2754494046477],
                  [-88.13150882720947, 40.27495827189585],
                  [-88.13146591186523, 40.2753839204869]]]),
            {
              "Type": 1,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.19596767425537, 40.24566394016615],
                  [-88.19609642028809, 40.24350197779441],
                  [-88.1953239440918, 40.24559842716937]]]),
            {
              "Type": 1,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.19266319274902, 40.25277172366235],
                  [-88.19292068481445, 40.2515598502302],
                  [-88.19244861602783, 40.25231317951046]]]),
            {
              "Type": 1,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.21665287017822, 40.24204425207184],
                  [-88.21590185165405, 40.241716668938395],
                  [-88.21603059768677, 40.242175284881384]]]),
            {
              "Type": 1,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.21193218231201, 40.24091408356245],
                  [-88.21085929870605, 40.24037356151916],
                  [-88.21111679077148, 40.24106149791623]]]),
            {
              "Type": 1,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.30716133117676, 40.2543766037265],
                  [-88.30711841583252, 40.25385256544151],
                  [-88.30668926239014, 40.254245594535696]]]),
            {
              "Type": 1,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.2855749130249, 40.26633012484342],
                  [-88.28608989715576, 40.266788574006775],
                  [-88.2872486114502, 40.26600265925294]]]),
            {
              "Type": 1,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.33436965942383, 40.03180418346705],
                  [-88.33398342132568, 40.030867674345984],
                  [-88.33340406417847, 40.03165631446071]]]),
            {
              "Type": 1,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.3319878578186, 40.03067051289251],
                  [-88.33125829696655, 40.02952039305533],
                  [-88.33125829696655, 40.03014474623038]]]),
            {
              "Type": 1,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.13931941986084, 40.09803366543276],
                  [-88.13768863677979, 40.097245793338246],
                  [-88.13704490661621, 40.097508418383335]]]),
            {
              "Type": 1,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.13794612884521, 40.09438968052552],
                  [-88.13846111297607, 40.093864405349265],
                  [-88.13798904418945, 40.09356893628097]]]),
            {
              "Type": 1,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.15403938293457, 40.099412419647486],
                  [-88.15408229827881, 40.09885435583079],
                  [-88.15361022949219, 40.0989035969399]]]),
            {
              "Type": 1,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.1669569015503, 40.067069995684825],
                  [-88.16897392272949, 40.067069995684825],
                  [-88.1696605682373, 40.06628176519301],
                  [-88.16880226135254, 40.06509940235425],
                  [-88.16798686981201, 40.06480380843811],
                  [-88.16837310791016, 40.06644598063095]]]),
            {
              "Type": 1,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.16609859466553, 40.064836652269925],
                  [-88.165283203125, 40.064409681221484],
                  [-88.164381980896, 40.064935183670286],
                  [-88.16395282745361, 40.06539499498781],
                  [-88.165283203125, 40.06516508971698]]]),
            {
              "Type": 1,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.16468238830566, 40.07393378400187],
                  [-88.16506862640381, 40.07294859374559],
                  [-88.16463947296143, 40.07196338923784],
                  [-88.1658411026001, 40.0707811250167],
                  [-88.1641674041748, 40.07209475066229],
                  [-88.164381980896, 40.07288291388844]]]),
            {
              "Type": 1,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.16506862640381, 40.076166829153465],
                  [-88.1663990020752, 40.07613399078467],
                  [-88.16648483276367, 40.0746890868802],
                  [-88.16601276397705, 40.075707090549145]]]),
            {
              "Type": 1,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.3384895324707, 39.88333052779651],
                  [-88.33896160125732, 39.88240844900134],
                  [-88.33833932876587, 39.882177927365035]]]),
            {
              "Type": 1,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.36363792419434, 39.880448990389795],
                  [-88.36312294006348, 39.880103197763546],
                  [-88.3625864982605, 39.880119664118595],
                  [-88.36286544799805, 39.88058072045542]]]),
            {
              "Type": 1,
              "system:index": "24"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.2736873626709, 40.226039963504896],
                  [-88.27411651611328, 40.22554847206815],
                  [-88.27398777008057, 40.224860378065635]]]),
            {
              "Type": 1,
              "system:index": "25"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.28325748443604, 40.20727884443912],
                  [-88.28278541564941, 40.2067872169029],
                  [-88.28250646591187, 40.20726245691203],
                  [-88.28295707702637, 40.20739355701786]]]),
            {
              "Type": 1,
              "system:index": "26"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.26210021972656, 40.23007005877096],
                  [-88.26128482818604, 40.22948030370999],
                  [-88.26149940490723, 40.230201114753804]]]),
            {
              "Type": 1,
              "system:index": "27"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.26823711395264, 40.230889154503046],
                  [-88.2679796218872, 40.23033217048303],
                  [-88.26772212982178, 40.23069257243079]]]),
            {
              "Type": 1,
              "system:index": "28"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.29518795013428, 40.20595144190796],
                  [-88.29505920410156, 40.20536147688369],
                  [-88.29441547393799, 40.20516482073456]]]),
            {
              "Type": 1,
              "system:index": "29"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.25703620910645, 39.88428552490491],
                  [-88.25729370117188, 39.883001215364565],
                  [-88.25669288635254, 39.88412087118005]]]),
            {
              "Type": 1,
              "system:index": "30"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.27651977539062, 39.88803952254783],
                  [-88.27677726745605, 39.88672235380119],
                  [-88.27643394470215, 39.88741387054864]]]),
            {
              "Type": 1,
              "system:index": "31"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.29278469085693, 39.89337379717348],
                  [-88.29265594482422, 39.892616487170955],
                  [-88.29239845275879, 39.893275018082456]]]),
            {
              "Type": 1,
              "system:index": "32"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.28132629394531, 39.896633427314555],
                  [-88.28162670135498, 39.89660050253263],
                  [-88.28136920928955, 39.896370028616325]]]),
            {
              "Type": 1,
              "system:index": "33"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.26313018798828, 39.90990082673086],
                  [-88.26295852661133, 39.9092424555833],
                  [-88.26265811920166, 39.90960456049752]]]),
            {
              "Type": 1,
              "system:index": "34"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.2627010345459, 39.90772817793077],
                  [-88.26210021972656, 39.907234384502566],
                  [-88.26210021972656, 39.90762941952987]]]),
            {
              "Type": 1,
              "system:index": "35"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.25943946838379, 39.91951232488118],
                  [-88.25986862182617, 39.91944649728978],
                  [-88.25986862182617, 39.918985702378144],
                  [-88.25939655303955, 39.91911735838358]]]),
            {
              "Type": 1,
              "system:index": "36"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.23738098144531, 39.93830351410292],
                  [-88.23802471160889, 39.93827060934887],
                  [-88.23776721954346, 39.93790865601035]]]),
            {
              "Type": 1,
              "system:index": "37"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.25849533081055, 39.97136479315381],
                  [-88.25746536254883, 39.97129901543516],
                  [-88.25746536254883, 39.9716607921043]]]),
            {
              "Type": 1,
              "system:index": "38"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.23789596557617, 39.96324076608185],
                  [-88.23819637298584, 39.96291183776863],
                  [-88.23772430419922, 39.96241844233175]]]),
            {
              "Type": 1,
              "system:index": "39"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.18888664245605, 39.978501299591215],
                  [-88.18888664245605, 39.97787647395675],
                  [-88.18845748901367, 39.977909359658916]]]),
            {
              "Type": 1,
              "system:index": "40"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.1416368484497, 39.99750642252139],
                  [-88.14206600189209, 39.99701327681833],
                  [-88.14142227172852, 39.99701327681833]]]),
            {
              "Type": 1,
              "system:index": "41"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.13275337219238, 40.01818245983016],
                  [-88.13258171081543, 40.01745939728386],
                  [-88.13172340393066, 40.01745939728386]]]),
            {
              "Type": 1,
              "system:index": "42"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.12944889068604, 40.017229330321484],
                  [-88.12889099121094, 40.017525130559186],
                  [-88.12987804412842, 40.017525130559186]]]),
            {
              "Type": 1,
              "system:index": "43"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.14228057861328, 40.02906033969047],
                  [-88.14228057861328, 40.02784446943277],
                  [-88.14189434051514, 40.02843597658951]]]),
            {
              "Type": 1,
              "system:index": "44"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.1647253036499, 40.060041285224315],
                  [-88.16463947296143, 40.05931866640852],
                  [-88.16442489624023, 40.059679976774355]]]),
            {
              "Type": 1,
              "system:index": "45"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.16888809204102, 40.065690586338796],
                  [-88.16901683807373, 40.06509940235425],
                  [-88.16798686981201, 40.06473812072702]]]),
            {
              "Type": 1,
              "system:index": "46"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.1647253036499, 40.073638228421395],
                  [-88.16502571105957, 40.07307995326986],
                  [-88.16468238830566, 40.071733506135416]]]),
            {
              "Type": 1,
              "system:index": "47"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.12781810760498, 40.07718481073223],
                  [-88.12786102294922, 40.07659372650697],
                  [-88.12687397003174, 40.07652805016525]]]),
            {
              "Type": 1,
              "system:index": "48"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.13897609710693, 40.098066493238726],
                  [-88.13790321350098, 40.097245793338246],
                  [-88.13790321350098, 40.09846042567505]]]),
            {
              "Type": 1,
              "system:index": "49"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.15554141998291, 40.10400806525872],
                  [-88.15554141998291, 40.10299048477415],
                  [-88.15442562103271, 40.103056135587295]]]),
            {
              "Type": 1,
              "system:index": "50"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.11279773712158, 40.10738894918339],
                  [-88.11249732971191, 40.10653553802725],
                  [-88.1120252609253, 40.10643706682028]]]),
            {
              "Type": 1,
              "system:index": "51"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.10884952545166, 40.12192811696267],
                  [-88.10884952545166, 40.121173338253904],
                  [-88.10730457305908, 40.12137023785531]]]),
            {
              "Type": 1,
              "system:index": "52"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.12386989593506, 40.12133742129466],
                  [-88.12017917633057, 40.12100925481713],
                  [-88.12090873718262, 40.121567136886505]]]),
            {
              "Type": 1,
              "system:index": "53"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.1262731552124, 40.13410186800043],
                  [-88.12528610229492, 40.13374095256816],
                  [-88.12528610229492, 40.13446278151591]]]),
            {
              "Type": 1,
              "system:index": "54"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.1072187423706, 40.147848037860975],
                  [-88.1079912185669, 40.14683111340554],
                  [-88.1065320968628, 40.146863917657846]]]),
            {
              "Type": 1,
              "system:index": "55"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.11155319213867, 40.15795084731743],
                  [-88.10936450958252, 40.15791804841991],
                  [-88.10876369476318, 40.158246036682385]]]),
            {
              "Type": 1,
              "system:index": "56"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.10189723968506, 40.17008535199224],
                  [-88.10215473175049, 40.16831450540802],
                  [-88.10133934020996, 40.16942948827397]]]),
            {
              "Type": 1,
              "system:index": "57"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.10155391693115, 40.17684037946411],
                  [-88.10185432434082, 40.17621737109768],
                  [-88.1008243560791, 40.17621737109768]]]),
            {
              "Type": 1,
              "system:index": "58"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.0900526046753, 40.18002091198069],
                  [-88.09065341949463, 40.17844705885363],
                  [-88.08958053588867, 40.17946350984005]]]),
            {
              "Type": 1,
              "system:index": "59"
            })]),
    othersCai = /* color: #ff0000 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.31484317779541, 40.26109048515934],
                  [-88.31196784973145, 40.2609594889675],
                  [-88.31196784973145, 40.26138522566361]]]),
            {
              "Type": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.32261085510254, 40.26744349599288],
                  [-88.32269668579102, 40.26560969845172],
                  [-88.32192420959473, 40.26682132025668]]]),
            {
              "Type": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.32934856414795, 40.264463549742366],
                  [-88.3297348022461, 40.26393958957863],
                  [-88.32883358001709, 40.26393958957863]]]),
            {
              "Type": 0,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.33518505096436, 40.270325077396635],
                  [-88.33368301391602, 40.26921175368047],
                  [-88.33282470703125, 40.269735673006274]]]),
            {
              "Type": 0,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.31793308258057, 40.277921385335304],
                  [-88.31857681274414, 40.27615335537133],
                  [-88.31754684448242, 40.27687366945583]]]),
            {
              "Type": 0,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.30969333648682, 40.278052348678735],
                  [-88.30990791320801, 40.27651351337276],
                  [-88.30917835235596, 40.277528493783]]]),
            {
              "Type": 0,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.3144998550415, 40.28338888913671],
                  [-88.31402778625488, 40.28181743631869],
                  [-88.31265449523926, 40.282144825334825]]]),
            {
              "Type": 0,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.22748899459839, 40.20645946323111],
                  [-88.22609424591064, 40.20508288050406],
                  [-88.22354078292847, 40.205181208768785],
                  [-88.22433471679688, 40.20600060542823]]]),
            {
              "Type": 0,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.22763919830322, 40.19964182756519],
                  [-88.22770357131958, 40.19772424400369],
                  [-88.22547197341919, 40.19862567892835]]]),
            {
              "Type": 0,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.23873281478882, 40.20831125065876],
                  [-88.23772430419922, 40.20706580627791],
                  [-88.2368016242981, 40.20955667215539]]]),
            {
              "Type": 0,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.23450565338135, 40.21219492368444],
                  [-88.23506355285645, 40.21411209793866],
                  [-88.23628664016724, 40.21293230481615]]]),
            {
              "Type": 0,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.24791669845581, 40.21319448284061],
                  [-88.24639320373535, 40.21550488282684],
                  [-88.24875354766846, 40.215603195972584]]]),
            {
              "Type": 0,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.26021194458008, 40.214161255539715],
                  [-88.25939655303955, 40.2118180368966],
                  [-88.25939655303955, 40.2142595706348]]]),
            {
              "Type": 0,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.34145069122314, 40.032970694388204],
                  [-88.34299564361572, 40.02841954590441],
                  [-88.33696603775024, 40.03352929818725]]]),
            {
              "Type": 0,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.33533525466919, 39.88563567053391],
                  [-88.33516359329224, 39.884400782277076],
                  [-88.33181619644165, 39.884384316950054],
                  [-88.33190202713013, 39.885932040405905]]]),
            {
              "Type": 0,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.35610628128052, 39.87868707643503],
                  [-88.3560848236084, 39.87723799178056],
                  [-88.3531665802002, 39.87715565650591],
                  [-88.35290908813477, 39.878720009821286]]]),
            {
              "Type": 0,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.3521580696106, 39.882342585755744],
                  [-88.35202932357788, 39.8815028238291],
                  [-88.34964752197266, 39.88163455187024],
                  [-88.34949731826782, 39.88230965410924]]]),
            {
              "Type": 0,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.34990501403809, 39.87990560119422],
                  [-88.34842443466187, 39.880416057833834],
                  [-88.34874629974365, 39.88109117206946],
                  [-88.35024833679199, 39.88046545666182]]]),
            {
              "Type": 0,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-88.32913398742676, 39.87878587654644],
                  [-88.32887649536133, 39.87727092586278],
                  [-88.32758903503418, 39.87819307374278]]]),
            {
              "Type": 0,
              "system:index": "18"
            })]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// Robert F Paul
// Classification of water cover in Planet Labs 
// Template

var currentDate = '2017-05-05';

// Create a mask of all pixels matching CDL crop class indices
// for the specified years within the extent
var CDL_Mask = function(years, crops, extent) {
  var result_img;
  
  // Get the CDL image for the year
  var FetchCDLYear = function(year) {
    // Start and end dates
    var start = ee.Date.fromYMD(year, 01, 01);
    var end = ee.Date.fromYMD(year, 12, 31);
    // Get the cropland layer for the year
    var result = ee.ImageCollection('USDA/NASS/CDL')
      .filterDate(start,end)
      .select('cropland') // Get the cropland cover values
      .first(); // Specifically get the image
    // Clip to extent geometry
    result = ee.Image(result).clip(extent);
    //print(result)
    return FetchCovers(result);
  }
  
  // Specified land covers = 1, all others = 0
  var FetchCovers = function(image) {
    // Remap cover ID values as 1, everything else as 0
    var result = image.remap(crops, // from
      ee.List.repeat(1, crops.length), // to
      0); // default value
    return result;
  }  
  
  // Mask from the union of all specified crop types for specified years
  result_img = ee.ImageCollection(years.map(FetchCDLYear)).and();
  
  // Return resulting mask
  return result_img;
}

// Remove cloud shadows, by dropping a buffered distance around 
// a specified percentage of "dark" pixels
// Cloud shadows typically lack enough information for a good classification,
// and processing artifacts around cloud shadow edges tend to be picked up by
// the classifier as false positives.
var Shadow_Mask = function(image, threshold, bufferDist, extent) {
  // print(image);
  // Get the mean of all bands
  var cloud_mask = image.reduce(ee.Reducer.mean());
  
  //Map.addLayer(cloud_mask, {min:2000, max: 8000, palette: ['violet', 'orange', 'yellow']}, "Mean values");
  
  // Get the n-th percentile value for the means
  var percentiles = cloud_mask.reduceRegion({
    reducer: ee.Reducer.percentile([threshold]),
    geometry: extent,
    scale: 30, // 3m x 10
    maxPixels: 1e12
  });
  // For everything below this percentile...  
  cloud_mask = cloud_mask.lt(ee.Image.constant(percentiles.get("mean")));

  // Measure the distance to the closest pixel below this threshold
  cloud_mask = cloud_mask.fastDistanceTransform(100).sqrt().multiply(ee.Image.pixelArea().sqrt());
  
  //Map.addLayer(cloud_mask, {min:0, max: bufferDist}, "Buffered"); // Distance
  
  // Mask out everything inside the buffer distance
  cloud_mask = cloud_mask
    .where(cloud_mask.lte(bufferDist), 0)
    .where(cloud_mask.gt(bufferDist), 1)
    .byte(); // */
  
  return cloud_mask
}

// Get the trainers associated with water vs not water cover for this date
var training_day = trainers.filter(ee.Filter.eq('date', currentDate)).select('cover');
var training_bands = ['b1', 'b2', 'b3', 'b4']

training_day = training_day.remap(['waterbody', 'pond', 'not_water'], [1, 1, 0], 'cover');

// Merge the polygons contributed by Yaping
training_day = training_day.merge(waterCai).merge(othersCai);

// Load Cropland Data Layer of maize and soybeans plots from 2013-2016
// Change champaign to clip region
var cdl_cult = CDL_Mask([2017], [1, 5, 111], champaign);
//print(cdl_cult);

// Define visualization parameters for a false color image.
// R is red, NIR is green, B is blue
var vizParams = {'bands': ['b1', 'b4', 'b3'], 'min':2000, 'max': 8000, 'gamma': 1.2};

// Mask image
var masked_pl = plImage.updateMask(cdl_cult);
// Clip to region of interest
masked_pl = masked_pl.clip(champaign);

// Mask of cloud shadow + buffer
var shade_mask = Shadow_Mask(
  masked_pl, // image
  5, // percentile
  150, // buffer distance, in meters
  champaign // AOI
  );
masked_pl = masked_pl.updateMask(shade_mask); // */

// Create the sampling raster with an added "cover" band
var sample_pl = masked_pl.clipToCollection(training_day);
sample_pl = ee.Image([sample_pl, 
  ee.Image()
    .byte()
    .paint(training_day, 'cover')
    .rename('cover')]);
print(sample_pl);

// Sample pixels for classification
//var training = masked_pl.reduceRegions(training_day, ee.Reducer.mean());
/*var training = masked_pl.select(training_bands)
  .sample({region: training_day, numPixels: 50})
  .limit(50);
//  tileScale: 16}); */
var training = sample_pl.stratifiedSample({ numPoints: 50, // value overridden
  classBand: 'cover', 
  region: training_day,
  scale: 6,
  classValues: [0, 1], // cover values to sample from 
  classPoints: [4500, 500] // sample
}); // */

/* var training = sample_pl.sampleRegions({
  collection: training_day,
  properties: ['cover']
}); // */

print(training.size());
// Train the classifier.
var classifier = ee.Classifier.randomForest({
  numberOfTrees: 30
}).train(training, "cover", training_bands);
print(classifier);
// Apply the classifier to the masked Planet Labs image
var classed_pl = masked_pl.classify(classifier).byte();

/*
// Confusion matrix for classification
var trainAcc = classifier.confusionMatrix();
print('Confusion matrix: ', trainAcc);
print('Training overall accuracy: ', trainAcc.accuracy());
print('Consumers Accuracy', trainAcc.consumersAccuracy());
print('Producers Accuracy', trainAcc.producersAccuracy());
print('Kappa', trainAcc.kappa());
*/

// Draw to map
//Map.setCenter(-94.866,42.967, 8);
//Map.setCenter(-96.37, 48.29, 8);*/
//Map.addLayer(cdl_cult);
Map.addLayer(masked_pl, vizParams, "Planet Labs");
//Map.addLayer(shade_mask, {min: 0, max: 1}, "Cloud shadow mask")
//Map.addLayer(sample_pl, vizParams, "Sample Raster");
Map.addLayer(training_day, {}, "Trainer Polys");
//Map.addLayer(waterCai, {}, "Water polygons, contributed");
//Map.addLayer(othersCai, {}, "Other polygons, contributed");
//Map.addLayer(sample_pl, {}, "Sample Points");
//Map.addLayer(training, {}, "Trainer Points")
Map.addLayer(classed_pl, {min: 0, max: 1, palette: ["a93f26","1fc1ff"]}, "Classification");

//Export image and mask. Uncomment this when ready to export data.
/*Export.image.toCloudStorage({
  image: classed_pl,
  description: '2017_05_05_PlanetLabs',
  bucket: 'gee_export_kovi',
  fileNamePrefix: 'PL/2017-05-05_randomForest30+Cai_int8',
  scale: 3,
  crs: "EPSG:32616",
  region: champaign,
  maxPixels: 1e13
}); // */