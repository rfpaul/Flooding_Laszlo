/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var vegetation = /* color: #35c61d */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-88.00297737121582, 37.902070623652016]),
            {
              "class": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.00666809082031, 37.92048971513834]),
            {
              "class": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.24047088623047, 37.892385207779405]),
            {
              "class": 0,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.1916332244873, 37.89638144288903]),
            {
              "class": 0,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.16390991210938, 37.895297739552]),
            {
              "class": 0,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.18442344665527, 37.90518594105217]),
            {
              "class": 0,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.17721366882324, 37.909181481181136]),
            {
              "class": 0,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.20734024047852, 37.91629165153156]),
            {
              "class": 0,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.09593200683594, 37.85029643183005]),
            {
              "class": 0,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.20356369018555, 37.866424722972056]),
            {
              "class": 0,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.18502426147461, 37.81938531124216]),
            {
              "class": 0,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.43397617340088, 37.76324447110752]),
            {
              "class": 0,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.37372303009033, 37.75747671727692]),
            {
              "class": 0,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.4494686126709, 37.760055298104895]),
            {
              "class": 0,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.45487594604492, 37.762905203919786]),
            {
              "class": 0,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.92461395263672, 37.73161129703045]),
            {
              "class": 0,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.93628692626953, 37.73117006082034]),
            {
              "class": 0,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.76960372924805, 37.78576154825086]),
            {
              "class": 0,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.77518272399902, 37.77029409275776]),
            {
              "class": 0,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.04125785827637, 37.831775669240166]),
            {
              "class": 0,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.03696632385254, 37.838893314035666]),
            {
              "class": 0,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.04147243499756, 37.838757746264825]),
            {
              "class": 0,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.14100646972656, 39.52969410195746]),
            {
              "class": 0,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.14461135864258, 39.52969410195746]),
            {
              "class": 0,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.15044784545898, 39.52148472172498]),
            {
              "class": 0,
              "system:index": "24"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.16400909423828, 39.52903209114215]),
            {
              "class": 0,
              "system:index": "25"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.11748886108398, 39.59872576348538]),
            {
              "class": 0,
              "system:index": "26"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.11062240600586, 39.59237652221032]),
            {
              "class": 0,
              "system:index": "27"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.1214370727539, 39.593963887088584]),
            {
              "class": 0,
              "system:index": "28"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.11139488220215, 39.58642357997858]),
            {
              "class": 0,
              "system:index": "29"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.08401489257812, 39.60190016588108]),
            {
              "class": 0,
              "system:index": "30"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.07543182373047, 39.61585258414924]),
            {
              "class": 0,
              "system:index": "31"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.06487464904785, 39.601437241260406]),
            {
              "class": 0,
              "system:index": "32"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.07620429992676, 39.60573570798439]),
            {
              "class": 0,
              "system:index": "33"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.2485523223877, 39.631034422197104]),
            {
              "class": 0,
              "system:index": "34"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.25614833831787, 39.6321251302308]),
            {
              "class": 0,
              "system:index": "35"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.25666332244873, 39.628489369911826]),
            {
              "class": 0,
              "system:index": "36"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.2474365234375, 39.628026623074156]),
            {
              "class": 0,
              "system:index": "37"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.24936771392822, 39.62177923785515]),
            {
              "class": 0,
              "system:index": "38"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.25533294677734, 39.62419231593219]),
            {
              "class": 0,
              "system:index": "39"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.26151275634766, 39.62776219492022]),
            {
              "class": 0,
              "system:index": "40"
            })]),
    mixed_soil_veg = /* color: #00ffff */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-87.9646110534668, 37.900242006365005]),
            {
              "class": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.19266319274902, 37.91100987633411]),
            {
              "class": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.4423017501831, 37.75991958556531]),
            {
              "class": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.42123031616211, 37.76938493820292]),
            {
              "class": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.83268928527832, 37.73554836527141]),
            {
              "class": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.80282020568848, 37.769954857908914]),
            {
              "class": 1,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.78093338012695, 37.7825055107824]),
            {
              "class": 1,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.75853157043457, 37.7898992222141]),
            {
              "class": 1,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.19412231445312, 37.8436814502461]),
            {
              "class": 1,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.10684585571289, 39.52991132288089]),
            {
              "class": 1,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.11165237426758, 39.53580292262571]),
            {
              "class": 1,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.11663055419922, 39.52017915876925]),
            {
              "class": 1,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.17825698852539, 39.5180604116651]),
            {
              "class": 1,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.19731140136719, 39.54354729867634]),
            {
              "class": 1,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.15903091430664, 39.53480999140904]),
            {
              "class": 1,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.06487464904785, 39.55777616406715]),
            {
              "class": 1,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.07448768615723, 39.590392264963896]),
            {
              "class": 1,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.07174110412598, 39.59925484065529]),
            {
              "class": 1,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.2430591583252, 39.62422537121202]),
            {
              "class": 1,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.24220085144043, 39.62035779632058]),
            {
              "class": 1,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.22975540161133, 39.63017506436212]),
            {
              "class": 1,
              "system:index": "20"
            })]),
    soil = /* color: #e18b1d */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-88.1392765045166, 37.8919787988361]),
            {
              "class": 2,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.16596984863281, 37.84799210216696]),
            {
              "class": 2,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.12382698059082, 37.80894310384489]),
            {
              "class": 2,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.38985919952393, 37.75991958556531]),
            {
              "class": 2,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.40307712554932, 37.75944458971607]),
            {
              "class": 2,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.88813591003418, 37.74267528383729]),
            {
              "class": 2,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.83123016357422, 37.72577318982807]),
            {
              "class": 2,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.7686595916748, 37.79152709600339]),
            {
              "class": 2,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.75655746459961, 37.77355066812127]),
            {
              "class": 2,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.66437530517578, 37.76615532127689]),
            {
              "class": 2,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.15053367614746, 39.53202970844552]),
            {
              "class": 2,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.15044784545898, 39.53070572504207]),
            {
              "class": 2,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.09560203552246, 39.60474377780674]),
            {
              "class": 2,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.09276962280273, 39.602230824429896]),
            {
              "class": 2,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.24129962921143, 39.62363037375897]),
            {
              "class": 2,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.241042137146, 39.62237425122433]),
            {
              "class": 2,
              "system:index": "15"
            })]),
    water = /* color: #2b3fa7 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-88.42736721038818, 37.77247194176241]),
            {
              "class": 3,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-88.04460525512695, 37.83194514495398]),
            {
              "class": 3,
              "system:index": "1"
            })]),
    champaign = ee.FeatureCollection("users/RobertFPaul/ChampaignCounty"),
    sinks = ee.Image("users/RobertFPaul/Champ_sinks_x10cm");
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// Robert F Paul
// 2013 Classification of cloud-free regions
// Champaign County Only

// Add county shape
//Map.addLayer(champaign, {}, "Champaign County");

// A mapping from a common name to the sensor-specific bands.
var LC8_BANDS = ['B2',   'B3',    'B4',  'B5',  'B6',    'B7',    'B10',   'B11'];
var STD_NAMES = ['blue', 'green', 'red', 'nir', 'swir1', 'swir2', 'temp1', 'temp2'];

// Get the Landsat 8 TOA collection of the 2013 growing season
var lsat = ee.ImageCollection('LC8_L1T_TOA')
    .filterDate('2015-05-10', '2015-10-10')
    .filterBounds(champaign)
    .select(LC8_BANDS);

var CloudMask = function (image) {
  // Get the simple cloud scores of the image
  var cloud_mask = ee.Algorithms.Landsat.simpleCloudScore(image).select('cloud');
  // Mask from cloud scores less than or equal to 5
  cloud_mask = cloud_mask.lte(5);
  return image.updateMask(cloud_mask);
}

// Create a mask of all pixels matching CDL crop class indices
// for the specified years within the extent
var CDL_Mask = function(years, crops, extent) {
  var year;
  var crop;
  var temp_img;
  var year_img;
  var crop_img;
  // Result-holding raster filled with 1 values
  var result_img = ee.Image(1).clip(extent);
  
  // Go through each year to extract
  for (year in years) {
    // Crop-holding raster filled with 0 values
    crop_img = ee.Image(0).clip(extent);
    // Get CDL for current year and clip it
    year_img = ee.Image('USDA/NASS/CDL/' + years[year]);
    year_img = year_img.select('cropland').clip(extent);
    
    // Combine crops together
    for (crop in crops) {
      // Crop matches index
      temp_img = year_img.eq(crops[crop]);
      // Union with crop image
      crop_img = crop_img.or(temp_img);
    }
    // Intersect unified crop mask with previous mask results
    result_img = result_img.multiply(crop_img);
  }
  // Return resulting mask
  return result_img;
}

// Max values of cloudless pixels in the growing season
var cloud_masked = lsat.map(CloudMask).max();

// Load Cropland Data Layer of maize and soybeans plots from 2013-2016
var cdl_cult = CDL_Mask([2013, 2014, 2015, 2016], [1, 5], champaign);
print(cdl_cult);

// Define visualization parameters for a false color image.
// NIR is green, SWIR1 is red, SWIR2 is blue
var vizParams = {'bands': ['B6', 'B5', 'B7'], 'max': .8, 'gamma': 1.6};

// Mask image
var masked_lsat = cloud_masked.updateMask(cdl_cult);
// Clip to the Corn Belt only
masked_lsat = masked_lsat.clip(champaign);

/*print(vegetation);

// Merge classifier points
var sites = vegetation.merge(water).merge(soil).merge(mixed_soil_veg);
//var sites = ee.FeatureCollection([vegetation, soil, mixed_soil_veg, water]).flatten();
// Sample pixels for classification
var training = masked_lsat.sampleRegions(sites, ["class"], 30);
// Train the classifier
var classifier = ee.Classifier.randomForest().train(training, "class", LC8_BANDS);
// Apply the classifier to the masked Landsat image
var classed_lsat = masked_lsat.classify(classifier);
// Remap values to prevent category 0 being lost to background after export
classed_lsat = classed_lsat.remap([0, 1, 2, 3], [1, 2, 3, 4]);
// Recast classified image as 8-bit depth integer
classed_lsat = classed_lsat.toInt8();

// Confusion matrix for classification
var trainAcc = classifier.confusionMatrix();
print('Confusion matrix: ', trainAcc);
print('Training overall accuracy: ', trainAcc.accuracy());
print('Consumers Accuracy', trainAcc.consumersAccuracy());
print('Producers Accuracy', trainAcc.producersAccuracy());
print('Kappa', trainAcc.kappa());

// Draw to map
//Map.setCenter(-94.866,42.967, 8);
//Map.setCenter(-96.37, 48.29, 8);*/
Map.addLayer(masked_lsat, vizParams, "Landsat Bands");
// Add sinks
Map.addLayer(sinks, {min:0, max: 20, opacity: .50, palette:['white', 'blue', 'yellow', 'red']}, "Sinks");
//Map.addLayer(classed_lsat, {min:1, max:4, palette:['green', 'yellow', 'red', 'blue']}, "Classification");

//Export image and mask. Uncomment this when ready to export data.
/*Export.image.toCloudStorage({
  image: classed_lsat,
  description: '2013_Classified_Corn_Belt',
  bucket: 'gee_export_kovi',
  fileNamePrefix: '2013/2013_cb_class_randomForest02_int8',
  scale: 30,
  region: champaign,
  maxPixels: 1e13
});*/