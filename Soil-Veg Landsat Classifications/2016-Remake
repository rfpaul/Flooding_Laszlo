/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var corn_belt_region = /* color: #98ff00 */ee.Geometry.Polygon(
        [[[-82.1337890625, 42.61132393345391],
          [-82.4853515625, 44.144375156142864],
          [-86.396484375, 45.299621281112216],
          [-87.802734375, 45.39227876798964],
          [-89.912109375, 45.48478459387111],
          [-91.93359375, 46.03663519715222],
          [-95.44921875, 47.09406201244411],
          [-95.2734375, 48.27734442028102],
          [-96.15234375, 49.290740050243485],
          [-100.37109375, 49.290740050243485],
          [-100.458984375, 48.30658277685742],
          [-100.5908203125, 46.854181436320886],
          [-100.458984375, 45.26870174864029],
          [-100.4150390625, 43.57402423617491],
          [-99.3603515625, 42.02644643428589],
          [-100.37109375, 40.573909721497564],
          [-99.1845703125, 39.90299481572232],
          [-95.8447265625, 39.22544552735803],
          [-94.04296874999994, 38.023863033250294],
          [-92.7685546875, 38.05847296216953],
          [-90.8349609375, 37.64207544142983],
          [-87.7587890625, 37.15331243359517],
          [-86.2646484375, 37.64207544142983],
          [-84.7705078125, 38.05847296216953],
          [-82.529296875, 38.747229512898734],
          [-81.298828125, 41.304222339667696]]]),
    vegetation = /* color: #35c61d */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-82.96995162963867, 40.71610269105921]),
            {
              "class": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.9903793334961, 40.72369544992874]),
            {
              "class": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.97965049743652, 40.730590184933426]),
            {
              "class": 0,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-83.01904678344727, 40.70190078963513]),
            {
              "class": 0,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([-83.00565719604492, 40.72070317286095]),
            {
              "class": 0,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([-83.02316665649414, 40.71432787315172]),
            {
              "class": 0,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([-83.02393913269043, 40.720052660045845]),
            {
              "class": 0,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([-83.02376747131348, 40.72694777242597]),
            {
              "class": 0,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-83.00617218017578, 40.72883404664989]),
            {
              "class": 0,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.94308662414551, 40.72213427867664]),
            {
              "class": 0,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.9782772064209, 40.69506815903583]),
            {
              "class": 0,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.98136711120605, 40.69344123893419]),
            {
              "class": 0,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.91690826416016, 40.75816198131912]),
            {
              "class": 0,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.90703773498535, 40.83899061627647]),
            {
              "class": 0,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.92755126953125, 40.84463974020632]),
            {
              "class": 0,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([-83.06161880493164, 40.83210712494613]),
            {
              "class": 0,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([-83.08221817016602, 40.8350943882113]),
            {
              "class": 0,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.45692253112793, 38.37993176741997]),
            {
              "class": 0,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.45331764221191, 38.38356499156617]),
            {
              "class": 0,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.46224403381348, 38.37582735027593]),
            {
              "class": 0,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.47031211853027, 38.37253019080881]),
            {
              "class": 0,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.47597694396973, 38.36055149019011]),
            {
              "class": 0,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.46996879577637, 38.35254215204421]),
            {
              "class": 0,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.46971130371094, 38.36842535377603]),
            {
              "class": 0,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.43658065795898, 38.35799398270416]),
            {
              "class": 0,
              "system:index": "24"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.85674858093262, 41.57582907876847]),
            {
              "class": 0,
              "system:index": "25"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.8597526550293, 41.56629347819897]),
            {
              "class": 0,
              "system:index": "26"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.87279891967773, 41.56488067692396]),
            {
              "class": 0,
              "system:index": "27"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.87739086151123, 41.56391738561539]),
            {
              "class": 0,
              "system:index": "28"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.88271236419678, 41.575186994985444]),
            {
              "class": 0,
              "system:index": "29"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.88181114196777, 41.572104903976474]),
            {
              "class": 0,
              "system:index": "30"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.85679149627686, 41.604234895568815]),
            {
              "class": 0,
              "system:index": "31"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.8473072052002, 41.59971006012162]),
            {
              "class": 0,
              "system:index": "32"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.86447334289551, 41.600191440676106]),
            {
              "class": 0,
              "system:index": "33"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.8698377609253, 41.60208483601839]),
            {
              "class": 0,
              "system:index": "34"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.82773780822754, 41.64866410823112]),
            {
              "class": 0,
              "system:index": "35"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.84314441680908, 41.64917719099954]),
            {
              "class": 0,
              "system:index": "36"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.84323024749756, 41.645842079961795]),
            {
              "class": 0,
              "system:index": "37"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.82863903045654, 41.63840159474369]),
            {
              "class": 0,
              "system:index": "38"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.81713771820068, 41.6403580124678]),
            {
              "class": 0,
              "system:index": "39"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.82069969177246, 41.64382168834534]),
            {
              "class": 0,
              "system:index": "40"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.85039710998535, 41.629484709390965]),
            {
              "class": 0,
              "system:index": "41"
            })]),
    mixed_soil_veg = /* color: #00ffff */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-83.01037788391113, 40.71402088381144]),
            {
              "class": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.96334266662598, 40.72369544992874]),
            {
              "class": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.95544624328613, 40.72707786202002]),
            {
              "class": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-83.02059173583984, 40.700599390218144]),
            {
              "class": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.92025566101074, 40.70046924887798]),
            {
              "class": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.93252944946289, 40.709708652174925]),
            {
              "class": 1,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.97106742858887, 40.75133512486954]),
            {
              "class": 1,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.91047096252441, 40.80976332419813]),
            {
              "class": 1,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-83.08290481567383, 40.83132781674085]),
            {
              "class": 1,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.44936943054199, 38.36667568033511]),
            {
              "class": 1,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.44301795959473, 38.380133617993245]),
            {
              "class": 1,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.48147010803223, 38.33012475794673]),
            {
              "class": 1,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.47992515563965, 38.40509146367529]),
            {
              "class": 1,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.4101448059082, 38.40542776394859]),
            {
              "class": 1,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.85837936401367, 41.56773835664045]),
            {
              "class": 1,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.84258651733398, 41.571302251974245]),
            {
              "class": 1,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.86610412597656, 41.609144464453195]),
            {
              "class": 1,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.82975482940674, 41.61745458248772]),
            {
              "class": 1,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.83099937438965, 41.616459991557996]),
            {
              "class": 1,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.85674858093262, 41.64638725414697]),
            {
              "class": 1,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.87370014190674, 41.63913926741817]),
            {
              "class": 1,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.87116813659668, 41.639171339951616]),
            {
              "class": 1,
              "system:index": "21"
            })]),
    soil = /* color: #e18b1d */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-82.97003746032715, 40.70849076720841]),
            {
              "class": 2,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.97475814819336, 40.70730132549998]),
            {
              "class": 2,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.9302978515625, 40.74899432699845]),
            {
              "class": 2,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([-82.92926788330078, 40.74873423325953]),
            {
              "class": 2,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.44267463684082, 38.36822347053778]),
            {
              "class": 2,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.88460063934326, 41.55592151349828]),
            {
              "class": 2,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.84031200408936, 41.604619973296735]),
            {
              "class": 2,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.85172748565674, 41.64154466313243]),
            {
              "class": 2,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.85189914703369, 41.64029386856612]),
            {
              "class": 2,
              "system:index": "8"
            })]),
    water = /* color: #2b3fa7 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-87.79732704162598, 38.32736417874693]),
            {
              "class": 3,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-87.43756771087646, 38.369107757011214]),
            {
              "class": 3,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([-89.8643445968628, 41.57117382672839]),
            {
              "class": 3,
              "system:index": "2"
            })]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// Robert F Paul
// 2016 Classification of cloud-free regions

// A mapping from a common name to the sensor-specific bands.
var LC8_BANDS = ['B2',   'B3',    'B4',  'B5',  'B6',    'B7',    'B10',   'B11'];
var STD_NAMES = ['blue', 'green', 'red', 'nir', 'swir1', 'swir2', 'temp1', 'temp2'];

// Get the Landsat 8 TOA collection of the 2016 growing season
var lsat = ee.ImageCollection('LANDSAT/LC08/C01/T1_TOA')
    .filterDate('2016-06-10', '2016-09-10')
    .filterBounds(corn_belt_region)
    .select(LC8_BANDS);

var CloudMask = function (image) {
  // Get the simple cloud scores of the image
  var cloud_mask = ee.Algorithms.Landsat.simpleCloudScore(image).select('cloud');
  // Mask from cloud scores less than or equal to 5
  cloud_mask = cloud_mask.lte(5);
  return image.updateMask(cloud_mask);
}

// Create a mask of all pixels matching CDL crop class indices
// for the specified years within the extent
var CDL_Mask = function(years, crops, extent) {
  var year;
  var crop;
  var temp_img;
  var year_img;
  var crop_img;
  // Result-holding raster filled with 1 values
  var result_img = ee.Image(1).clip(extent);
  
  // Go through each year to extract
  for (year in years) {
    // Crop-holding raster filled with 0 values
    crop_img = ee.Image(0).clip(extent);
    // Get CDL for current year and clip it
    year_img = ee.Image('USDA/NASS/CDL/' + years[year]);
    year_img = year_img.select('cropland').clip(extent);
    
    // Combine crops together
    for (crop in crops) {
      // Crop matches index
      temp_img = year_img.eq(crops[crop]);
      // Union with crop image
      crop_img = crop_img.or(temp_img);
    }
    // Intersect unified crop mask with previous mask results
    result_img = result_img.multiply(crop_img);
  }
  // Return resulting mask
  return result_img;
}

// Max values of cloudless pixels in the growing season
var cloud_masked = lsat.map(CloudMask).max();

// Load Cropland Data Layer of maize and soybeans plots from 2013-2016
var cdl_cult = CDL_Mask([2013, 2014, 2015, 2016], [1, 5], corn_belt_region);
print(cdl_cult);

// Define visualization parameters for a false color image.
// NIR is green, SWIR1 is red, SWIR2 is blue
var vizParams = {'bands': ['B6', 'B5', 'B7'], 'max': .8, 'gamma': 1.6};

// Mask image
var masked_lsat = cloud_masked.updateMask(cdl_cult);
// Clip to the Corn Belt only
masked_lsat = masked_lsat.clip(corn_belt_region);

//print(vegetation);

// Merge classifier points
var sites = vegetation.merge(water).merge(soil).merge(mixed_soil_veg);
//var sites = ee.FeatureCollection([vegetation, soil, mixed_soil_veg, water]).flatten();
// Sample pixels for classification
var training = masked_lsat.sampleRegions(sites, ["class"], 30);

// Train the classifier
var classifier = ee.Classifier.randomForest().train(training, "class", LC8_BANDS);
// Apply the classifier to the masked Landsat image
var classed_lsat = masked_lsat.classify(classifier);
// Remap values to prevent category 0 being lost to background after export
classed_lsat = classed_lsat.remap([0, 1, 2, 3], [1, 2, 3, 4]);
// Recast classified image as 8-bit depth integer
classed_lsat = classed_lsat.toInt8();

// Confusion matrix for classification
var trainAcc = classifier.confusionMatrix();
print('Resubstitution error matrix: ', trainAcc);
print('Training overall accuracy: ', trainAcc.accuracy());

// Draw to map
//Map.setCenter(-94.866,42.967, 8);
//Map.setCenter(-96.37, 48.29, 8); 
//Map.addLayer(cdl_cult);
Map.addLayer(masked_lsat, vizParams);
Map.addLayer(classed_lsat, {min:1, max:4, palette:['green', 'yellow', 'red', 'blue']});

//Export image and mask. Uncomment this when ready to export data.
/*Export.image.toCloudStorage({
  image: classed_lsat,
  description: '2016_Classified_Corn_Belt',
  bucket: 'gee_export_kovi',
  fileNamePrefix: '2016/2016_cb_class_randomForest02_int8',
  scale: 30,
  region: corn_belt_region,
  maxPixels: 1e13
});*/